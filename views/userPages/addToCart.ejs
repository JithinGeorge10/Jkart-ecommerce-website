<%- include('../userPartials/header') %>

  <!-- LIGHT SECTION -->
  <section class="lightSection clearfix pageHeaderImage">
    <div class="container">
      <div class="tableBlock">
        <div class="row tableInner">
          <div class="col-sm-12">
            <div class="page-title">
              <h2>cart</h2>
              <ol class="breadcrumb">
                <li>
                  <a href='/'>Home</a>
                </li>

                <li class="active">cart</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN CONTENT SECTION -->
  <section class="mainContent clearfix cartListWrapper">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="cartListInner text-nowrap">
            <form action="#">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th></th>
                      <th>Product Name</th>
                      <th>Price</th>
                      <th>Quantity</th>
                      <th>Sub Total</th>
                      <th>Remove</th>
                    </tr>
                  </thead>
                  <tbody>

                    <% for(let i=0;i<productDetails.length;i++){ %>
                      <tr class="alert alert-dismissible fade show p-0 mb-0" role="alert">
                        <td class="">

                          <span class="cartImage"><img src="/assets/img/uploads/<%=productDetails[i].productImage[0]%> "
                              style="height: 60px; width: 60px; border-radius: 0;" alt="image"></span>
                        </td>
                        <td class="">
                          <%=productDetails[i].productName%>
                        </td>
                        <td class="">₹ <%=productDetails[i].productPrice%>
                        </td>
                        <td class="count-input">

                          <button id="decrement" onclick="fnDecButton(`<%= i %>`)" class="btn btn-primary btn-sm"
                            type="button">-</button>


                          <input class="quantity" type="text" id="productQuantity<%= i %>"
                            value="<%=productDet[i].productQuantity%>">

                          <button id="increment"
                            onclick="fnIncButton('<%=productDetails[i].productStock%>',`<%= i %>`,'<%=productDet[i].productId%>')"
                            class="btn btn-primary btn-sm" type="button">+</button>

                        </td>
                        <td>
                          <h4 id="totalCostPerProduct<%=i%>"> ₹<%=productDet[i].totalCostPerProduct%>
                          </h4>

                        </td>
                        <td>
                          <button onclick="removeCart('<%=productDetails[i]._id%>')" type="button" class="btn btn-danger"
                            aria-label="Close">Remove</button>
                        </td>
                      </tr>


                      <script>
                        async function fnIncButton(maxStock, index, pid) {
                          try {
                            var inputElement = document.getElementById('productQuantity' + index);
                            var currentValue = parseInt(inputElement.value);

                            if (currentValue < maxStock) {
                              inputElement.value = currentValue + 1;
                              let response = await fetch(`cart/qtyInc?id=${pid}`, {
                                method: 'PUT'
                              })
                              let result = await response.json()
                              if (result.success) {

                                document.getElementById('productQuantity' + index).innerHTML = result.updatedPrice.productQuantity

                                document.getElementById('totalCostPerProduct' + index).innerHTML = '₹' + result.updatedPrice.totalCostPerProduct
                              }

                            } else {
                              await Swal.fire({
                                icon: "warning",
                                title: "Oops...",
                                text: "Maximum quantity reached",
                              });
                            }
                          } catch (error) {
                            console.error(error);
                          }
                        }


                        async function fnDecButton(index) {
                          var inputElement = document.getElementById('productQuantity' + index);
                          var currentValue = parseInt(inputElement.value);
                          if (currentValue > 1) {
                            inputElement.value = currentValue - 1;
                          } else {
                            await Swal.fire({
                              icon: "warning",
                              title: "Minimum one quantity",
                              text: "Please select at least one quantity.",
                            });
                          }
                        }


                        async function removeCart(productId) {
                          Swal.fire({
                            title: "Are you sure?",
                            text: "You won't be able to revert this!",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Yes, remove it!"
                          }).then(async (result) => {
                            if (result.isConfirmed) {
                              let response = await fetch(`/removeCart?pid=${productId}`, {
                                method: 'POST'
                              })
                              let result = await response.json()
                              if (success) {
                                await Swal.fire({
                                  icon: "success",
                                  title: "Item removed from cart"
                                })
                                window.location.reload()
                              }
                            }
                          });


                        }
                      </script>


                      <% } %>




                  </tbody>
                </table>
              </div>

              <!-- <div class="updateArea">
                    <firm class="input-group">
                      <input type="text" class="form-control" required placeholder="I have a discount coupon" aria-describedby="basic-addon2">
                      <button type="submit" class="btn btn-primary-outlined" id="basic-addon2">apply coupon</button>
                    </firm>
                  
                  </div> -->

              <div class="row totalAmountArea">
                <div class="col-sm-5 ms-sm-auto">
                  <ul class="list-unstyled">

                    <li id="total-price">Grand Total <span id="grandTotal" class="price">

                      </span></li>
                  </ul>
                </div>
              </div>

              <div class="checkBtnArea">
                <a class='btn btn-primary btn-default' href='checkout-step-2.html'>checkout<i
                    class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
  <%- include('../userPartials/footer') %>